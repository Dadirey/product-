<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gradient-to-r from-purple-50 to-blue-100 font-sans">
    <div class="container mx-auto p-6 shadow-lg rounded-lg bg-white my-8">
      <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">
        Sales Dashboard
      </h1>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 items-center">
        <div>
          <label for="csvFile" class="block text-gray-700 text-sm font-bold mb-2">
            Choose CSV File:
          </label>
          <input type="file" id="csvFile" accept=".csv" class="shadow border rounded w-full py-2 px-3 text-gray-700 focus:outline-none" />
        </div>
        <div>
          <label for="search" class="block text-gray-700 text-sm font-bold mb-2">
            Search:
          </label>
          <input type="text" id="search" placeholder="Product Name or S/N" class="shadow border rounded w-full py-2 px-3 text-gray-700 focus:outline-none" />
        </div>
      </div>
      <div class="overflow-x-auto bg-white rounded-lg shadow-md">
        <table class="min-w-full">
          <thead id="tableHead" class="bg-gray-50"></thead>
          <tbody id="tableBody" class="divide-y divide-gray-200">
            <tr>
              <td colspan="6" class="text-center py-4">No data loaded yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="mt-8">
        <canvas id="salesChart"></canvas>
      </div>
    </div>
    <script>
      let originalData = [];
      let filteredData = [];
      let selectedRow = null;
      let chartInstance = null;

      document.getElementById("csvFile").addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          Papa.parse(e.target.result, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              originalData = results.data;
              filteredData = [...originalData];
              localStorage.setItem("csvData", JSON.stringify(originalData)); // Save to localStorage
              displayData(filteredData);
              updateChart(filteredData);
            },
          });
        };
        reader.readAsText(file);
      });

      document.getElementById("search").addEventListener("input", () => {
        const query = document.getElementById("search").value.toLowerCase();
        filteredData = originalData.filter((row) =>
          Object.values(row).some((value) =>
            value.toString().toLowerCase().includes(query)
          )
        );
        displayData(filteredData);
        updateChart(filteredData);
      });

      function displayData(data) {
        const tableBody = document.getElementById("tableBody");
        tableBody.innerHTML =
          data.length === 0
            ? `<tr><td colspan="6" class="text-center py-4">No matching data found.</td></tr>`
            : data.map((row, index) => `
                <tr class="cursor-pointer hover:bg-gray-100" onclick="handleRowClick(this, ${index})">
                  ${Object.values(row).map(value => `<td class="px-6 py-4 text-sm text-gray-900">${value}</td>`).join("")}
                </tr>
              `).join("");
      }

      function handleRowClick(rowElement, index) {
        if (selectedRow) {
          selectedRow.classList.remove("bg-blue-200");
        }
        rowElement.classList.add("bg-blue-200");
        selectedRow = rowElement;
      }

      function updateChart(data) {
        const labels = data.map((row, index) => row[Object.keys(row)[0]] || `Item ${index + 1}`);
        const values = data.map((row) => parseFloat(row[Object.keys(row)[1]]) || 0);

        const ctx = document.getElementById("salesChart").getContext("2d");
        if (chartInstance) {
          chartInstance.destroy();
        }
        chartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{
              label: "Sales Data",
              data: values,
              backgroundColor: values.map(value => `hsl(${(value / Math.max(...values)) * 120}, 80%, 60%)`),
              borderColor: "#4A90E2",
              borderWidth: 1,
            }],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      // Load saved data on refresh
      window.addEventListener("load", () => {
        const savedData = localStorage.getItem("csvData");
        if (savedData) {
          originalData = JSON.parse(savedData);
          filteredData = [...originalData];
          displayData(filteredData);
          updateChart(filteredData);
        }
      });
    </script>
  </body>
</html>
